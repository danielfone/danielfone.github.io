<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ActionDispatch::Cookies::CookieOverflow via Devise's user_return_to - Daniel Fone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/atom.xml" rel="alternate" title="Daniel Fone" type="application/atom+xml">
    <link href="/favicon.png" rel="icon">
    <!-- Bootstrap -->
    <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41009873-1', 'fone.net.nz');
  ga('send', 'pageview');

</script>

  </head>
  <body>
    <div class="blog-masthead">
      <div class="container">
        <nav class="blog-nav">
          <a class=" blog-nav-item" href="/">Home</a>
          <a class=" blog-nav-item" href="/blog/archives/">Articles</a>
          <a class=" blog-nav-item" href="/hire/">Hire</a>
          <a class="external blog-nav-item" href="https://github.com/danielfone">Code</a>
        </nav>
      </div>
    </div>

    <div class="container">
        <header>
    <img style="float: left; margin-right: 1em; width: 5em" src="/images/blue-dot.png" />
    <h1><a href="/">Daniel Fone</a></h1>
    <p class="lead">Ruby/Rails Engineer</p>
  </header>

  <div class="row">
    <div class="col-md-9">
        <article>
    <h2>
      ActionDispatch::Cookies::CookieOverflow via Devise's user_return_to
    </h2>
    <p>
      <small class="text-muted">
        November 2014
      </small>
    </p>


    <blockquote>
  <p>tl;dr If you’re going to submit forms via GET, keep your parameter names short!</p>
</blockquote>

<p>Today I came across an exception that was caused by a collision of two uncommon circumstances:</p>

<ul>
  <li>A large and complex form, submitted via GET (it was a search for with a <em>lot</em> of parameters)</li>
  <li>A Devise session time out</li>
</ul>

<h3 id="how-it-happens">How It Happens</h3>

<ol>
  <li>A user who signed in some time ago has the form open. They submit the form which GETs a very long url from the server.</li>
  <li>Devise attempts to authenticate the user and realises that their session has expired.</li>
  <li>Devise attempts to redirect the user to the sign in form, but first it stores the url in the session as <code>user_return_to</code>.</li>
  <li>The url is too long to fit in the session and a ActionDispatch::Cookies::CookieOverflow exception is raised.</li>
</ol>

<h3 id="reproducible-test-case">Reproducible Test Case</h3>

<p>Fortunately, it’s very easy to replicate the problem in tests. Anytime an unauthenticated user requests a url approaching ActionDispatch::Cookies::MAX_COOKIE_SIZE, Devise will attempt to store the the url and cause the exception to be raised.</p>

<pre class="highlight ruby"><code>  <span class="c1"># /spec/requests/large_request_spec.rb</span>
  <span class="nb">require</span> <span class="s1">'spec_helper'</span>

  <span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'A very large request'</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'should not overflow cookies'</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">foo: </span><span class="s1">'x'</span> <span class="o">*</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Cookies</span><span class="o">::</span><span class="no">MAX_COOKIE_SIZE</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">redirect_to</span> <span class="s1">'/users/sign_in'</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre>

<p>This reliably produces</p>

<pre class="highlight plaintext"><code>1) A very large request should not overflow cookies
   Failure/Error: get '/', foo: 'bar' * 1000
   ActionDispatch::Cookies::CookieOverflow:
     ActionDispatch::Cookies::CookieOverflow
</code></pre>

<h3 id="solutions">Solutions</h3>

<p>There were a couple of approaches that I didn’t want to pursue.</p>

<ul>
  <li>Changing the form method to POST. This substantially alters the behaviour of the form, “breaking” the back and refresh functionality, and preventing users from easily sharing search results.</li>
  <li>Abbreviating the parameter name. Because the forms are all generated by rails helpers, this would require overriding a lot of simple behaviour. The form is also dynamic and the number of GET parameters is not fixed. This means we can never ensure that the GET url will be small enough.</li>
</ul>

<p>Ultimately, I wanted to solve this at the Devise level. The problematic behaviour is defined in the <a href="https://github.com/plataformatec/devise/blob/v3.4.1/lib/devise/controllers/store_location.rb">store_location module</a>, which is included into Devise’s <a href="https://github.com/plataformatec/devise/blob/a93edc72fd9f6cc5839dd74107b215a81c16dc37/lib/devise/failure_app.rb">failure app</a>.</p>

<p>I wrote a simple initializer to monkey patch the method and prevent it storing excessively long urls in the session.</p>

<pre class="highlight ruby"><code>  <span class="c1"># /config/initializers/devise_safe_store_location.rb</span>
  <span class="k">module</span> <span class="nn">SafeStoreLocation</span>

    <span class="no">MAX_LOCATION_SIZE</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Cookies</span><span class="o">::</span><span class="no">MAX_COOKIE_SIZE</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">store_location_for</span><span class="p">(</span><span class="n">resource_or_scope</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
      <span class="k">super</span> <span class="k">unless</span> <span class="n">location</span><span class="p">.</span><span class="nf">size</span> <span class="o">&gt;</span> <span class="no">MAX_LOCATION_SIZE</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="no">Devise</span><span class="o">::</span><span class="no">FailureApp</span><span class="p">.</span><span class="nf">include</span> <span class="no">SafeStoreLocation</span>
</code></pre>

<p>The downside to this approach is that the user loses their place in the form, but it is far better than an unhandled exception when submitting. I’ve submitted a <a href="https://github.com/plataformatec/devise/pull/3347">pull request</a> to the Devise project, but to be honest this is such an edge case that it may not warrant it. We’ll see what happens.</p>


  </article>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'danielfone';
    var disqus_identifier = 'http://daniel.fone.net.nz/blog/2014/11/28/actiondispatch-cookies-cookieoverflow-via-devise-s-user_return_to/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    </div>
    <div class="col-md-3">
      <aside>
        <img width="70" class="img-thumbnail" style="float: right" src="//www.gravatar.com/avatar/5efc2a040a61cb22107bcfcecd58454c.jpg?s=300" />
        <h4>About Me</h4>
        <p>
          I'm a Ruby/Rails engineer, based in Christchurch, New&nbsp;Zealand.
          I'm available for freelancing, consulting and remote contracting.
        </p>
        <p>
          Follow me on <a href="https://twitter.com/danielfone">Twitter</a>.
        </p>
        <p>
          <a href="/hire" class="button primary">Hire me</a>
        </p>
      </aside>
    </div>
  </div>


      <div class="blog-footer">
        <p>
          &copy; 2014 Daniel Fone
          -
          Powered by
          <a href="http://middlemanapp.com/">Middleman</a>
          and
          <a href="http://pages.github.com/">GitHub Pages</a>
        </p>
        <p>
          <a href="#">Back to top</a>
        </p>
      </div>

    </div>

  </body>
</html>
